<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <div class="d-flex justify-content-between mb-3">
      <h1>Simple Shop</h1>
      {% if user.is_authenticated %}
        <div>
          Logged in as {{ user.username }}

        </div>
      {% else %}
        <a href="{% url 'shop:signup' %}" class="btn btn-primary">Sign Up</a>
      {% endif %} 
    </div>

    <div class="row">
      <div class="col-md-8">
        <form id="cart-form">
          <table class="table">
            <thead><tr><th>Product</th><th>Price</th><th>Qty</th></tr></thead>
            <tbody>
              {% for p in products %}
              <tr>
                <td>{{ p.name }}</td>
                <td>{{ p.price}}</td>
                <td>
                  <input type="number" min="0" value="0" class="form-control qty-input"
                         data-product-id="{{ p.id }}">
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <button id="buy-btn" class="btn btn-primary">Buy</button>
        </form>
      </div>

      <div class="col-md-4">
        <h4>My Orders</h4>
        <ul class="list-group">
          {% for o in orders %}
            <li class="list-group-item">Order #{{ o.id }} — {{ o.amount_display }} — Paid</li>
          {% empty %}
            <li class="list-group-item">No orders yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

<script src="https://js.stripe.com/v3/"></script>
<script>
const publishableKey = "{{ STRIPE_PUBLISHABLE_KEY }}";
const stripe = Stripe(publishableKey);

async function createCheckout(items){
  const resp = await fetch('/create-checkout-session/', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
    body: JSON.stringify({items})
  });
  const data = await resp.json();
  if (data.error) { alert(data.error); document.getElementById('buy-btn').disabled = false; return; }
  document.getElementById('buy-btn').disabled = true;
  stripe.redirectToCheckout({ sessionId: data.id });
}

document.getElementById('cart-form').addEventListener('submit', function(e){
  e.preventDefault();
  const inputs = document.querySelectorAll('.qty-input');
  const items = [];
  inputs.forEach(inp => {
    const qty = parseInt(inp.value) || 0;
    if (qty > 0) {
      items.push({product_id: inp.dataset.productId, quantity: qty});
    }
  });
  if (items.length === 0) { alert('Select at least one item'); return; }
  document.getElementById('buy-btn').disabled = true; // immediate defensive disable
  createCheckout(items);
});
</script>
</body>
</html>
